<!DOCTYPE html>
<html>
<head>
    <title>Probabilistic Snow Accumulation Forecast (7 - 9 December)</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="icon" type="image/x-icon" href="favicon.ico">
    <script src="https://api.mapbox.com/mapbox-gl-js/v3.14.0/mapbox-gl.js"></script>
    <link href="https://api.mapbox.com/mapbox-gl-js/v3.14.0/mapbox-gl.css" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css?family=Roboto:400,500,700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="app-bar">
        <div class="app-bar-left">
            <div class="logo"><img src="logo.png"> </div>
            <div class="title-container">
                <div class="title">Probabilistic Snow Accumulation Forecast</div>
                <div class="subtitle">In the Contigous United States (7 - 9 December, 2025)</div>
            </div>
        </div>
        <div class="app-bar-right">
            <div class="radio-group">
                <span style="font-size: x-large;">üóìÔ∏è</span>
                
                <input type="radio" id="radio-24" name="estimates" value="24 Hours" checked class="custom-radio">
                <label for="radio-24">
                    <span class="radio-visual"></span>
                    7th December
                </label>
                
                <input type="radio" id="radio-48" name="estimates" value="48 Hours" class="custom-radio">
                <label for="radio-48">
                    <span class="radio-visual"></span>
                    8th December
                </label>
                
                <input type="radio" id="radio-72" name="estimates" value="72 Hours" class="custom-radio">
                <label for="radio-72">
                    <span class="radio-visual"></span>
                    9th December
                </label>

                
                <input type="radio" id="radio-none" name="estimates" value="None" class="custom-radio">
                <label for="radio-none">
                    <span class="radio-visual"></span>
                    None
                </label>
            </div>
            <button class="help-button" id="help-btn">
                <i class="material-icons">help_outline</i>
            </button>
        </div>
    </div>
    
    <div class="opacity-control" id="opacity-control" title="Snow layer opacity">
        <span class="material-icons" style="font-size:20px; line-height:0; color: #ffffff;">opacity</span>
        <input id="opacity-slider" type="range" min="0" max="100" value="70" />
        <span id="opacity-value">70%</span>
    </div>

    <div id="splash-screen">
        <div class="splash-content">
            <button class="splash-close" id="splash-close-btn" title="Close">&times;</button>
            
            <div class="splash-header">
                <div class="splash-logo-container">
                    <div class="splash-logo"><img src="logo.png"></div>
                </div>
                <h3>Welcome to the Probabilistic Snow Forecast Map</h3>
                <p style="text-align: center; font-size: 16px;">Contiguous United States | December 7-9, 2025</p>
            </div>

            <div class="splash-body">
                <h4>Application Description</h4>
                <p>This interactive map visualizes the Probabilistic Snow Accumulation Forecast. Use it to track the expected snow totals over a 3-day period. Data is provided by the National Weather Service (NWS) and processed via Mapbox Studio, offering hypsometric cartographic visualization method and minimal interractivity.</p>

                <h4>How to Use the App</h4>
                <ul>
                    <li><strong>Select a Date:</strong> Use the radio buttons in the top right corner to switch between the 7th, 8th, and 9th of December forecast periods.</li>
                    <li><strong>View Accumulation:</strong> Tap/hover your mouse over any colored region on the map to see the forecast snow accumulation in inches.</li>
                    <li><strong>Get Point Details:</strong> Zoom in and click on a major observation point (city markers) to open a detailed pop-up with the point's elevation and the full 3-day accumulation forecast.</li>
                    <li><strong>Legend:</strong> The legend in the bottom left explains the color ramp used to visualize the snow accumulation layers.</li>
                </ul>

                <h4>Authors & Data Source</h4>
                <p>This application was developed by: <br><a target="_blank" href="https://bamideleoke.dev">Bamidele Clement OKE</a> and <a target="_blank" href="https://linkedin.com/in/bukharisyedanoorulsaba">Bukhari Syeda Noor Ul Saba</a>
                </p>
                <p>Data Source: ¬© <a target="_blank" href="https://www.wpc.ncep.noaa.gov/">National Weather Service (NWS)</a></p>
            </div>

            <img src="cde.png" alt="Snowy Landscape Banner" class="splash-footer-image">
        </div>
    </div>

    <div id="map"></div>
 
    <div class="mobile-radio-group">
        <span style="font-size: x-large;">üóìÔ∏è</span>
        
        <input type="radio" id="mobile-radio-24" name="estimates" value="24 Hours" checked class="custom-radio">
        <label for="mobile-radio-24">
            <span class="radio-visual"></span>
            7th December
        </label>

        <input type="radio" id="mobile-radio-48" name="estimates" value="48 Hours" class="custom-radio">
        <label for="mobile-radio-48">
            <span class="radio-visual"></span>
            8th December
        </label>

        <input type="radio" id="mobile-radio-72" name="estimates" value="72 Hours" class="custom-radio">
        <label for="mobile-radio-72">
            <span class="radio-visual"></span>
            9th December
        </label>


        <input type="radio" id="mobile-radio-none" name="estimates" value="None" class="custom-radio">
        <label for="mobile-radio-none">
            <span class="radio-visual"></span>
            None
        </label>
    </div>

    <div id="legend-container">
        <div id="legend-content">
            <div class="legend-row">
                <span class="legend-key" style="background-color: #08306b"></span>
                <label>8 in.</label>
            </div>
            <div class="legend-row">
                <span class="legend-key" style="background-color: #08519c"></span>
                <label>7 in.</label>
            </div>
            <div class="legend-row">
                <span class="legend-key" style="background-color: #2171b5"></span>
                <label>5.9 in.</label>
            </div>
            <div class="legend-row">
                <span class="legend-key" style="background-color: #4292c6"></span>
                <label>5.36 in.</label>
            </div>
            <div class="legend-row">
                <span class="legend-key" style="background-color: #6baed6"></span>
                <label>8.85 in.</label>
            </div>
            <div class="legend-row">
                <span class="legend-key" style="background-color: #9ecae1"></span>
                <label>3.8 in.</label>
            </div>
            <div class="legend-row">
                <span class="legend-key" style="background-color: #c6dbef"></span>
                <label>2.75 in.</label>
            </div>
            <div class="legend-row">
                <span class="legend-key" style="background-color: #deebf7"></span>
                <label>1.7 in.</label>
            </div>
            <div class="legend-row">
                <span class="legend-key" style="background-color: #edf8fb"></span>
                <label>0.65 in.</label>
            </div>
            <div class="legend-row">
                <span class="legend-key" style="background-color: #ffffff"></span>
                <label>0 in.</label>
            </div>
        </div>
    </div>
    
    <div id="fixed-popup" class="map-overlay rounded" style="background: white; display: none;"></div>


    <script>
        const splashScreen = document.getElementById('splash-screen');
        const splashCloseBtn = document.getElementById('splash-close-btn');
        const helpButton = document.getElementById('help-btn');

        function toggleSplashDialog(show) {
            if (show) {
                splashScreen.style.display = 'flex';
            } else {
                splashScreen.style.display = 'none';
            }
        }

        splashCloseBtn.addEventListener('click', () => {
            toggleSplashDialog(false);
        });

        splashScreen.addEventListener('click', (e) => {
            if (e.target === splashScreen) {
                toggleSplashDialog(false);
            }
        });

        helpButton.addEventListener('click', (e) => {
            toggleSplashDialog(true);
        });

        mapboxgl.accessToken = 'pk.eyJ1IjoiYmFtaWRlbGVva2UiLCJhIjoiY21qYnJyYWQzMGRibTNmczk2ZDB0cW9nZiJ9.1qjPvLribErYWkQ4eLf8Vw';

        const LAYER_ID_DENSITY_24HRS = 'snow-prob-24hrs-393jyj';
        const LAYER_ID_DENSITY_48HRS = 'snow-prob-48hrs-6n3sww';
        const LAYER_ID_DENSITY_72HRS = 'snow-prob-72hrs-0rymaf';
        const LAYER_ID_DENSITY_NONE = '';
        const LAYER_ID_POINTS = 'snow-prob-combined-3rf07b';

        const map = new mapboxgl.Map({
            center: [-98.92195958552794, 39.50717345756227],
            zoom: 4,
            container: 'map', 
            attributionControl: false, 
            style: 'mapbox://styles/bamideleoke/cmjbd5mt6002j01sd5ea48oxf' 
        });


        const scale = new mapboxgl.ScaleControl({
            maxWidth: 100,
            unit: 'metric'
        });

        map.addControl(scale, 'bottom-right');

        const pdTooltip = document.createElement('div');
        pdTooltip.className = 'pd-tooltip';
        pdTooltip.style.display = 'none';
        document.body.appendChild(pdTooltip);
        
        const fixedPopup = document.getElementById('fixed-popup');
        
        let activeDensityLayer = LAYER_ID_DENSITY_24HRS; 

        function handleDensityHover(event) {
            map.getCanvas().style.cursor = 'crosshair';

            const zone = event.features[0];
            const amount = zone.properties.amount.toLocaleString();
            const tooltipContent = `<strong>${amount} inches</strong><br><em>Snow accumulation</em>`; 
            
            pdTooltip.style.left = `${event.originalEvent.clientX + 15}px`;
            pdTooltip.style.top = `${event.originalEvent.clientY + 15}px`;
            pdTooltip.innerHTML = tooltipContent;
            pdTooltip.style.display = 'block';
        }

        function handleDensityLeave() {
            pdTooltip.style.display = 'none';
        }

        function handleCityHover(event) {
            if (!event.features || !event.features.length) return;
            map.getCanvas().style.cursor = 'pointer';
        }

        function handleCityLeave() {
            map.getCanvas().style.cursor = '';
        }
        
        function handleCityClick(e) {
            const properties = e.features[0].properties;
            const dateRange = "3 day forecast"; 

            const elevation = properties.elev_in_ft && properties.elev_in_ft >= 1 ? `${properties.elev_in_ft.toLocaleString()} ft` : 'Unknown';

            const description = `
                <button id="close-fixed-popup" class="close-button" title="Close Popup">
                    &times;
                </button>

                <h4>${properties.name}, ${properties.state}</h4>
                <div class="date-range">${dateRange}</div>

                <div class="estimate-row">
                    <div class="estimate-column">
                        <div class="value">${elevation} </div>
                        <div class="label">Elevation</div>
                    </div>
                </div>
                
                <div class="probabilities-header">SNOW ACCUMULATION</div>
                <div class="probability-table">
                    
                    <div class="probability-description">Sunday, December 7</div>
                    <div class="probability-value">${properties.amount24} inches</div>
                    
                    <div class="probability-description">Monday, December 8</div>
                    <div class="probability-value">${properties.amount48} inches</div>
                    
                    <div class="probability-description">Tuesday, December 9</div>
                    <div class="probability-value">${properties.amount72} inches</div>

                    </div>
                
                `;

            fixedPopup.innerHTML = description;
            fixedPopup.style.display = 'block';

            document.getElementById('close-fixed-popup').onclick = () => {
                fixedPopup.style.display = 'none';
            };
        }
        
        function toggleDensityLayer(newLayerId) {
            if (map.getLayer(activeDensityLayer)) {
                map.setLayoutProperty(activeDensityLayer, 'visibility', 'none');
            }

            if (map.getLayer(newLayerId)) {
                map.setLayoutProperty(newLayerId, 'visibility', 'visible');
            }
            
            if (newLayerId === LAYER_ID_DENSITY_NONE) {
                map.setLayoutProperty(activeDensityLayer, 'visibility', 'none');
            }

            const isNone = (newLayerId === LAYER_ID_DENSITY_NONE);
            opacityControl.style.display = isNone ? 'none' : 'flex';

            activeDensityLayer = newLayerId;
        }

        
        let activeOpacity = 0.7;

        map.on('load', () => {
            if (map.getLayer(LAYER_ID_DENSITY_48HRS)) {
                 map.setLayoutProperty(LAYER_ID_DENSITY_48HRS, 'visibility', 'none');
            }
            if (map.getLayer(LAYER_ID_DENSITY_72HRS)) {
                 map.setLayoutProperty(LAYER_ID_DENSITY_72HRS, 'visibility', 'none');
            }
            map.on('mouseenter', LAYER_ID_POINTS, handleCityHover);
            map.on('mouseleave', LAYER_ID_POINTS, handleCityLeave);
            map.on('mousemove', activeDensityLayer, handleDensityHover);
            map.on('mouseleave', activeDensityLayer, handleDensityLeave);
            map.on('click', LAYER_ID_POINTS, handleCityClick);

            opacityControl.style.display = 'flex';
            setActiveLayerOpacity(activeOpacity);
        });

        map.on('idle', () => {
            map.on('mouseenter', LAYER_ID_POINTS, handleCityHover);
            map.on('mouseleave', LAYER_ID_POINTS, handleCityLeave);
            map.on('mousemove', activeDensityLayer, handleDensityHover);
            map.on('mouseleave', activeDensityLayer, handleDensityLeave);
            map.on('click', LAYER_ID_POINTS, handleCityClick);
        });

        map.on('click', (e) => {
            const features = map.queryRenderedFeatures(e.point, { layers: [LAYER_ID_POINTS] });
            if (!features.length) {
                fixedPopup.style.display = 'none';
            }
        });

        document.querySelectorAll('input[name="estimates"]').forEach((radio) => {
            radio.addEventListener('change', (e) => {
                const value = e.target.value;
                console.log(`Estimate chosen: ${value}`);

                fixedPopup.style.display = 'none';

                if (value === '24 Hours') {
                    toggleDensityLayer(LAYER_ID_DENSITY_24HRS);
                } else if (value === '48 Hours') {
                    toggleDensityLayer(LAYER_ID_DENSITY_48HRS);
                } else if (value === '72 Hours') {
                    toggleDensityLayer(LAYER_ID_DENSITY_72HRS); 
                } else if (value === 'None') {
                    toggleDensityLayer(LAYER_ID_DENSITY_NONE); 
                }
            });
        });

        map.addControl(new mapboxgl.NavigationControl(), 'top-right');

        map.addControl(
            new mapboxgl.AttributionControl({
                customAttribution: 'Authors: <a target="_blank" href="https://bamideleoke.dev">Bamidele Clement OKE</a> and Bukhari Syeda Noor Ul Saba | Data ¬© <a target="_blank" href="https://livingatlas.arcgis.com">ArcGIS Living Atlas</a>',
                compact: true 
            }),
            'bottom-right' 
        );

        const opacityControl = document.getElementById('opacity-control');
        const opacitySlider  = document.getElementById('opacity-slider');
        const opacityValueEl = document.getElementById('opacity-value');

        function setActiveLayerOpacity(opacity01) {
            activeOpacity = opacity01;

            const pct = Math.round(opacity01 * 100);
            opacitySlider.value = pct;
            opacityValueEl.textContent = `${pct}%`;

            if (activeDensityLayer && map.getLayer(activeDensityLayer)) {
                map.setPaintProperty(activeDensityLayer, 'fill-opacity', opacity01);
            }
        }

        opacitySlider.addEventListener('input', (e) => {
            setActiveLayerOpacity(Number(e.target.value) / 100);
        });


    </script>
</body>
</html>
